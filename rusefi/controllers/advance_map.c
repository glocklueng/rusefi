/*
 * advance.c
 *
 *  Created on: Mar 27, 2013
 *      Author: Andrey Belomutskiy, (c) 2012-2013
 */

#include "advance_map.h"
#include "engine_controller.h"


#define RPM_COUNT 22
static float rpm_table[] = {600.0, 800.0, 1000.0, 1200.0, 1400.0, 1600.0, 1800.0, 2000.0, 2200.0, 2400.0, 2600.0, 2800.0, 3000.0, 3200.0, 3400.0, 3600.0, 3800.0, 4000.0, 4200.0, 4400.0, 4600.0, 4800.0};

#define MAF_COUNT 33
static float maf_table[] = {1.0, 1.1, 1.2000000000000002, 1.3000000000000003, 1.4000000000000004, 1.5000000000000004, 1.6000000000000005, 1.7000000000000006, 1.8000000000000007, 1.9000000000000008, 2.000000000000001, 2.100000000000001, 2.200000000000001, 2.300000000000001, 2.4000000000000012, 2.5000000000000013, 2.6000000000000014, 2.7000000000000015, 2.8000000000000016, 2.9000000000000017, 3.0000000000000018, 3.100000000000002, 3.200000000000002, 3.300000000000002, 3.400000000000002, 3.500000000000002, 3.6000000000000023, 3.7000000000000024, 3.8000000000000025, 3.9000000000000026, 4.000000000000003, 4.100000000000002, 4.200000000000002};

static float ad_table[22][33] = {
{/*0*/-1.35, /*1*/-1.35, /*2*/-1.332, /*3*/-1.332, /*4*/-1.332, /*5*/-1.332, /*6*/-1.332, /*7*/-1.332, /*8*/-1.314, /*9*/-1.314, /*10*/-1.314, /*11*/-0.27, /*12*/0.774, /*13*/1.781, /*14*/2.466, /*15*/2.466, /*16*/2.466, /*17*/2.466, /*18*/2.466, /*19*/2.466, /*20*/2.466, /*21*/2.466, /*22*/2.466, /*23*/2.466, /*24*/2.466, /*25*/2.466, /*26*/2.466, /*27*/2.466, /*28*/2.466, /*29*/2.466, /*30*/2.466, /*31*/2.483, /*32*/2.483},
{/*0*/-1.464, /*1*/-1.44, /*2*/-1.44, /*3*/-1.44, /*4*/-1.44, /*5*/-1.44, /*6*/-1.44, /*7*/-1.44, /*8*/-1.44, /*9*/-1.44, /*10*/-1.44, /*11*/-1.44, /*12*/-1.08, /*13*/0.312, /*14*/1.248, /*15*/2.303, /*16*/2.471, /*17*/2.471, /*18*/2.471, /*19*/2.471, /*20*/2.471, /*21*/2.471, /*22*/2.471, /*23*/2.471, /*24*/2.477, /*25*/2.483, /*26*/2.471, /*27*/2.471, /*28*/2.471, /*29*/2.471, /*30*/2.471, /*31*/2.471, /*32*/2.471},
{/*0*/-1.409, /*1*/-1.409, /*2*/-1.409, /*3*/-1.409, /*4*/-1.409, /*5*/-1.409, /*6*/-1.409, /*7*/-1.409, /*8*/-1.409, /*9*/-1.409, /*10*/-1.409, /*11*/-1.409, /*12*/-1.409, /*13*/-1.409, /*14*/-0.69, /*15*/0.72, /*16*/1.77, /*17*/2.309, /*18*/2.309, /*19*/2.309, /*20*/2.309, /*21*/2.309, /*22*/2.309, /*23*/2.309, /*24*/2.309, /*25*/2.309, /*26*/2.309, /*27*/2.309, /*28*/2.309, /*29*/2.309, /*30*/2.309, /*31*/2.309, /*32*/2.309},
{/*0*/-3.456, /*1*/-3.456, /*2*/-3.456, /*3*/-3.456, /*4*/-3.456, /*5*/-3.456, /*6*/-3.456, /*7*/-3.456, /*8*/-3.456, /*9*/-3.456, /*10*/-3.456, /*11*/-3.456, /*12*/-3.456, /*13*/-3.095, /*14*/-2.7, /*15*/-1.475, /*16*/0.108, /*17*/0.828, /*18*/1.26, /*19*/1.26, /*20*/1.26, /*21*/1.26, /*22*/1.26, /*23*/1.26, /*24*/1.26, /*25*/1.26, /*26*/1.26, /*27*/1.26, /*28*/1.26, /*29*/1.26, /*30*/1.26, /*31*/1.26, /*32*/1.252},
{/*0*/-5.543, /*1*/-5.543, /*2*/-5.543, /*3*/-5.543, /*4*/-5.543, /*5*/-5.543, /*6*/-5.543, /*7*/-5.543, /*8*/-5.543, /*9*/-5.543, /*10*/-5.504, /*11*/-5.543, /*12*/-5.543, /*13*/-5.375, /*14*/-5.296, /*15*/-3.907, /*16*/-2.855, /*17*/-1.973, /*18*/-0.587, /*19*/0.293, /*20*/0.63, /*21*/0.629, /*22*/0.629, /*23*/0.629, /*24*/0.587, /*25*/0.503, /*26*/0.503, /*27*/0.503, /*28*/0.587, /*29*/0.671, /*30*/0.629, /*31*/0.713, /*32*/0.629},
{/*0*/-7.584, /*1*/-7.535, /*2*/-7.535, /*3*/-7.535, /*4*/-7.535, /*5*/-7.535, /*6*/-7.535, /*7*/-7.584, /*8*/-7.584, /*9*/-7.584, /*10*/-7.584, /*11*/-7.584, /*12*/-7.584, /*13*/-7.392, /*14*/-7.056, /*15*/-6.051, /*16*/-4.895, /*17*/-4.223, /*18*/-2.783, /*19*/-2.063, /*20*/-0.336, /*21*/-0.336, /*22*/-0.336, /*23*/-0.336, /*24*/-0.288, /*25*/-0.336, /*26*/-0.288, /*27*/-0.288, /*28*/-0.288, /*29*/-0.288, /*30*/-0.288, /*31*/-0.24, /*32*/-0.096},
{/*0*/-9.664, /*1*/-9.664, /*2*/-9.664, /*3*/-9.664, /*4*/-9.664, /*5*/-9.664, /*6*/-9.664, /*7*/-9.664, /*8*/-9.664, /*9*/-9.664, /*10*/-9.664, /*11*/-9.664, /*12*/-9.664, /*13*/-9.664, /*14*/-9.237, /*15*/-7.99, /*16*/-6.964, /*17*/-6.856, /*18*/-5.182, /*19*/-4.319, /*20*/-2.213, /*21*/-1.349, /*22*/-1.295, /*23*/-1.295, /*24*/-1.349, /*25*/-1.295, /*26*/-1.295, /*27*/-1.241, /*28*/-1.295, /*29*/-1.134, /*30*/-1.134, /*31*/-1.187, /*32*/-1.133},
{/*0*/-11.88, /*1*/-11.88, /*2*/-11.88, /*3*/-11.88, /*4*/-11.88, /*5*/-11.88, /*6*/-11.88, /*7*/-11.88, /*8*/-11.88, /*9*/-11.88, /*10*/-11.88, /*11*/-11.88, /*12*/-11.88, /*13*/-11.88, /*14*/-11.699, /*15*/-10.8, /*16*/-9.06, /*17*/-7.679, /*18*/-7.669, /*19*/-7.679, /*20*/-4.8, /*21*/-3.18, /*22*/-2.46, /*23*/-2.4, /*24*/-2.4, /*25*/-2.339, /*26*/-2.339, /*27*/-2.339, /*28*/-2.339, /*29*/-2.279, /*30*/-2.279, /*31*/-2.22, /*32*/-2.22},
{/*0*/-11.151, /*1*/-11.154, /*2*/-11.151, /*3*/-11.151, /*4*/-11.151, /*5*/-11.151, /*6*/-11.093, /*7*/-11.151, /*8*/-11.151, /*9*/-11.151, /*10*/-11.151, /*11*/-11.151, /*12*/-11.151, /*13*/-11.151, /*14*/-11.151, /*15*/-11.546, /*16*/-9.567, /*17*/-8.379, /*18*/-8.313, /*19*/-6.598, /*20*/-5.872, /*21*/-4.82, /*22*/-2.969, /*23*/-2.441, /*24*/-2.377, /*25*/-2.375, /*26*/-2.375, /*27*/-2.243, /*28*/-2.311, /*29*/-2.243, /*30*/-2.309, /*31*/-2.245, /*32*/-2.111},
{/*0*/-11.951, /*1*/-11.951, /*2*/-11.951, /*3*/-11.951, /*4*/-11.951, /*5*/-11.951, /*6*/-11.951, /*7*/-11.951, /*8*/-11.951, /*9*/-11.951, /*10*/-11.951, /*11*/-11.951, /*12*/-11.951, /*13*/-11.951, /*14*/-11.951, /*15*/-11.592, /*16*/-10.302, /*17*/-8.496, /*18*/-9.071, /*19*/-7.559, /*20*/-6.48, /*21*/-5.616, /*22*/-4.535, /*23*/-2.808, /*24*/-2.447, /*25*/-2.447, /*26*/-2.447, /*27*/-2.447, /*28*/-2.447, /*29*/-2.447, /*30*/-2.447, /*31*/-2.447, /*32*/-2.52},
{/*0*/-13.336, /*1*/-13.336, /*2*/-13.336, /*3*/-13.336, /*4*/-13.336, /*5*/-13.336, /*6*/-13.336, /*7*/-13.336, /*8*/-13.336, /*9*/-13.336, /*10*/-13.336, /*11*/-13.336, /*12*/-13.336, /*13*/-13.336, /*14*/-13.336, /*15*/-13.336, /*16*/-12.411, /*17*/-9.784, /*18*/-8.889, /*19*/-7.876, /*20*/-5.615, /*21*/-6.322, /*22*/-5.615, /*23*/-4.055, /*24*/-2.419, /*25*/-2.417, /*26*/-2.417, /*27*/-2.417, /*28*/-2.417, /*29*/-2.417, /*30*/-2.417, /*31*/-2.417, /*32*/-2.417},
{/*0*/-12.089, /*1*/-12.089, /*2*/-12.1, /*3*/-12.089, /*4*/-12.1, /*5*/-12.089, /*6*/-12.1, /*7*/-12.089, /*8*/-12.089, /*9*/-12.089, /*10*/-12.089, /*11*/-12.089, /*12*/-12.089, /*13*/-12.089, /*14*/-12.089, /*15*/-12.089, /*16*/-11.68, /*17*/-10.83, /*18*/-11.207, /*19*/-8.731, /*20*/-7.31, /*21*/-6.806, /*22*/-5.546, /*23*/-5.373, /*24*/-3.277, /*25*/-2.602, /*26*/-2.521, /*27*/-2.575, /*28*/-2.521, /*29*/-2.521, /*30*/-2.521, /*31*/-2.521, /*32*/-2.521},
{/*0*/-11.97, /*1*/-11.97, /*2*/-11.97, /*3*/-11.97, /*4*/-11.97, /*5*/-11.97, /*6*/-11.97, /*7*/-11.97, /*8*/-11.97, /*9*/-11.97, /*10*/-11.97, /*11*/-11.97, /*12*/-11.97, /*13*/-11.97, /*14*/-11.97, /*15*/-11.97, /*16*/-11.699, /*17*/-11.699, /*18*/-8.165, /*19*/-8.909, /*20*/-7.559, /*21*/-7.019, /*22*/-6.3, /*23*/-5.579, /*24*/-3.96, /*25*/-2.609, /*26*/-2.339, /*27*/-2.43, /*28*/-2.339, /*29*/-2.339, /*30*/-2.339, /*31*/-2.339, /*32*/-2.339},
{/*0*/-12.473, /*1*/-12.569, /*2*/-12.377, /*3*/-12.39, /*4*/-12.39, /*5*/-12.39, /*6*/-12.473, /*7*/-12.473, /*8*/-12.473, /*9*/-12.473, /*10*/-12.473, /*11*/-12.473, /*12*/-12.473, /*13*/-12.486, /*14*/-12.39, /*15*/-12.473, /*16*/-12.486, /*17*/-12.473, /*18*/-10.181, /*19*/-8.827, /*20*/-8.068, /*21*/-7.388, /*22*/-6.819, /*23*/-6.051, /*24*/-5.09, /*25*/-2.305, /*26*/-2.305, /*27*/-2.305, /*28*/-2.305, /*29*/-2.305, /*30*/-2.398, /*31*/-2.305, /*32*/-2.305},
{/*0*/-13.163, /*1*/-13.163, /*2*/-13.163, /*3*/-13.163, /*4*/-13.25, /*5*/-13.25, /*6*/-13.163, /*7*/-13.265, /*8*/-13.25, /*9*/-13.25, /*10*/-13.25, /*11*/-13.265, /*12*/-13.25, /*13*/-13.25, /*14*/-13.265, /*15*/-13.178, /*16*/-13.265, /*17*/-13.25, /*18*/-13.163, /*19*/-9.081, /*20*/-8.367, /*21*/-7.755, /*22*/-7.746, /*23*/-5.612, /*24*/-5.612, /*25*/-2.551, /*26*/-2.446, /*27*/-2.346, /*28*/-2.346, /*29*/-2.346, /*30*/-2.346, /*31*/-2.346, /*32*/-2.346},
{/*0*/-14.134, /*1*/-14.119, /*2*/-14.024, /*3*/-14.134, /*4*/-14.119, /*5*/-14.134, /*6*/-14.028, /*7*/-14.028, /*8*/-14.028, /*9*/-14.227, /*10*/-11.884, /*11*/-11.776, /*12*/-14.119, /*13*/-11.884, /*14*/-11.884, /*15*/-11.884, /*16*/-11.884, /*17*/-11.884, /*18*/-11.02, /*19*/-10.264, /*20*/-8.751, /*21*/-7.995, /*22*/-7.338, /*23*/-6.798, /*24*/-5.935, /*25*/-4.753, /*26*/-3.025, /*27*/-2.268, /*28*/-2.374, /*29*/-2.268, /*30*/-2.268, /*31*/-2.268, /*32*/-2.268},
{/*0*/-12.075, /*1*/-11.977, /*2*/-12.075, /*3*/-12.075, /*4*/-11.977, /*5*/-12.075, /*6*/-12.075, /*7*/-12.075, /*8*/-12.075, /*9*/-12.075, /*10*/-11.977, /*11*/-11.977, /*12*/-11.977, /*13*/-11.977, /*14*/-11.977, /*15*/-12.075, /*16*/-11.977, /*17*/-11.634, /*18*/-11.406, /*19*/-10.936, /*20*/-9.113, /*21*/-8.441, /*22*/-8.544, /*23*/-7.072, /*24*/-6.379, /*25*/-5.581, /*26*/-4.101, /*27*/-2.506, /*28*/-2.506, /*29*/-2.506, /*30*/-2.506, /*31*/-2.392, /*32*/-2.506},
{/*0*/-11.88, /*1*/-11.88, /*2*/-11.88, /*3*/-11.88, /*4*/-11.88, /*5*/-11.88, /*6*/-11.88, /*7*/-11.88, /*8*/-11.88, /*9*/-11.88, /*10*/-11.88, /*11*/-11.88, /*12*/-11.88, /*13*/-11.88, /*14*/-11.88, /*15*/-11.88, /*16*/-12.0, /*17*/-12.0, /*18*/-11.64, /*19*/-11.039, /*20*/-9.359, /*21*/-8.76, /*22*/-8.76, /*23*/-7.44, /*24*/-6.719, /*25*/-6.0, /*26*/-4.559, /*27*/-2.76, /*28*/-2.4, /*29*/-2.4, /*30*/-2.4, /*31*/-2.4, /*32*/-2.4},
{/*0*/-11.974, /*1*/-11.848, /*2*/-11.848, /*3*/-11.848, /*4*/-11.848, /*5*/-11.958, /*6*/-11.848, /*7*/-11.848, /*8*/-11.974, /*9*/-11.974, /*10*/-11.974, /*11*/-11.974, /*12*/-11.974, /*13*/-11.974, /*14*/-11.974, /*15*/-11.974, /*16*/-11.958, /*17*/-11.958, /*18*/-11.596, /*19*/-10.462, /*20*/-9.579, /*21*/-8.823, /*22*/-8.319, /*23*/-7.436, /*24*/-6.176, /*25*/-6.176, /*26*/-5.168, /*27*/-3.403, /*28*/-2.268, /*29*/-2.268, /*30*/-2.268, /*31*/-2.268, /*32*/-2.268},
{/*0*/-12.008, /*1*/-12.008, /*2*/-12.008, /*3*/-12.008, /*4*/-12.008, /*5*/-12.026, /*6*/-12.14, /*7*/-12.008, /*8*/-12.008, /*9*/-12.008, /*10*/-12.008, /*11*/-12.008, /*12*/-12.008, /*13*/-12.008, /*14*/-12.008, /*15*/-12.008, /*16*/-12.008, /*17*/-12.008, /*18*/-12.008, /*19*/-11.744, /*20*/-10.293, /*21*/-9.237, /*22*/-8.577, /*23*/-7.785, /*24*/-7.258, /*25*/-6.466, /*26*/-5.674, /*27*/-4.222, /*28*/-2.639, /*29*/-2.507, /*30*/-2.375, /*31*/-2.507, /*32*/-2.378},
{/*0*/-12.009, /*1*/-12.147, /*2*/-12.009, /*3*/-12.009, /*4*/-12.009, /*5*/-12.009, /*6*/-12.009, /*7*/-12.009, /*8*/-12.009, /*9*/-12.009, /*10*/-11.871, /*11*/-12.009, /*12*/-12.009, /*13*/-12.009, /*14*/-11.871, /*15*/-11.99, /*16*/-12.009, /*17*/-12.009, /*18*/-12.009, /*19*/-11.595, /*20*/-10.474, /*21*/-9.524, /*22*/-8.834, /*23*/-8.282, /*24*/-7.453, /*25*/-5.935, /*26*/-5.935, /*27*/-4.831, /*28*/-2.898, /*29*/-2.346, /*30*/-2.346, /*31*/-2.484, /*32*/-2.346},
{/*0*/-11.951, /*1*/-11.951, /*2*/-11.951, /*3*/-11.951, /*4*/-11.951, /*5*/-11.951, /*6*/-11.951, /*7*/-11.951, /*8*/-11.951, /*9*/-11.951, /*10*/-11.951, /*11*/-11.951, /*12*/-11.951, /*13*/-11.807, /*14*/-11.951, /*15*/-11.951, /*16*/-11.807, /*17*/-11.807, /*18*/-11.807, /*19*/-11.663, /*20*/-10.8, /*21*/-9.791, /*22*/-8.508, /*23*/-8.352, /*24*/-7.487, /*25*/-6.912, /*26*/-6.191, /*27*/-5.328, /*28*/-3.312, /*29*/-2.303, /*30*/-2.303, /*31*/-2.303, /*32*/-2.303}
};

float getAdvance(int rpm, float maf) {
	int rpm_index = findIndex(&rpm_table, RPM_COUNT, rpm);
	int maf_index = findIndex(&maf_table, MAF_COUNT, maf);

	return ad_table[rpm_index][maf_index];
}
