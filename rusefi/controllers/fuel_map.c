/*
 * fuel.c
 *
 *  Created on: May 27, 2013
 *      Author: Andrey Belomutskiy, (c) 2012-2013
 */

#include "fuel_map.h"
#include "engine_math.h"
#include "stdio.h"

#define FUEL_RPM_COUNT 23
static float fuel_rpm_table[] = {400.0, 650.0, 900.0, 1150.0, 1400.0, 1650.0, 1900.0, 2150.0, 2400.0, 2650.0, 2900.0, 3150.0, 3400.0, 3650.0, 3900.0, 4150.0, 4400.0, 4650.0, 4900.0, 5150.0, 5400.0, 5650.0, 5900.0};

#define FUEL_MAF_COUNT 28
static float fuel_maf_table[] = {1.7999999523162842, 1.8999999523162843, 1.9999999523162844, 2.0999999523162844, 2.1999999523162845, 2.2999999523162846, 2.3999999523162847, 2.499999952316285, 2.599999952316285, 2.699999952316285, 2.799999952316285, 2.899999952316285, 2.9999999523162852, 3.0999999523162853, 3.1999999523162854, 3.2999999523162855, 3.3999999523162856, 3.4999999523162857, 3.599999952316286, 3.699999952316286, 3.799999952316286, 3.899999952316286, 3.999999952316286, 4.099999952316286, 4.199999952316285, 4.299999952316285, 4.399999952316285, 4.499999952316284};

static float fuel_table[23][28] = {
{/*0*//*0*/3.22, /*1*/2.97, /*2*/3.77, /*3*/5.46, /*4*/7.65, /*5*/10.31, /*6*/13.27, /*7*/16.17, /*8*/16.93, /*9*/16.87, /*10*/16.87, /*11*/16.79, /*12*/16.73, /*13*/16.7, /*14*/16.67, /*15*/16.63, /*16*/16.59, /*17*/16.54, /*18*/16.29, /*19*/16.02, /*20*/15.86, /*21*/15.59, /*22*/15.47, /*23*/15.28, /*24*/15.14, /*25*/15.02, /*26*/14.85, /*27*/14.81},
{/*1*//*0*/3.0, /*1*/2.0, /*2*/2.35, /*3*/2.94, /*4*/3.79, /*5*/4.98, /*6*/6.48, /*7*/8.46, /*8*/13.72, /*9*/14.22, /*10*/14.39, /*11*/14.42, /*12*/14.42, /*13*/14.4, /*14*/14.4, /*15*/14.39, /*16*/14.4, /*17*/14.39, /*18*/14.4, /*19*/14.4, /*20*/14.4, /*21*/14.39, /*22*/14.38, /*23*/14.4, /*24*/14.4, /*25*/14.39, /*26*/14.42, /*27*/14.4},
{/*2*//*0*/2.72, /*1*/1.6, /*2*/1.85, /*3*/2.39, /*4*/3.2, /*5*/4.36, /*6*/5.48, /*7*/7.03, /*8*/8.88, /*9*/11.17, /*10*/14.4, /*11*/14.39, /*12*/14.39, /*13*/14.42, /*14*/14.39, /*15*/14.4, /*16*/14.39, /*17*/14.39, /*18*/14.4, /*19*/14.4, /*20*/14.42, /*21*/14.42, /*22*/14.38, /*23*/14.39, /*24*/14.39, /*25*/14.42, /*26*/14.4, /*27*/14.4},
{/*3*//*0*/1.61, /*1*/1.61, /*2*/1.71, /*3*/2.18, /*4*/2.84, /*5*/3.83, /*6*/4.8, /*7*/5.88, /*8*/7.26, /*9*/8.92, /*10*/11.02, /*11*/13.55, /*12*/14.42, /*13*/14.39, /*14*/14.4, /*15*/14.39, /*16*/14.4, /*17*/14.39, /*18*/14.4, /*19*/14.39, /*20*/14.39, /*21*/14.4, /*22*/14.42, /*23*/14.39, /*24*/14.39, /*25*/14.39, /*26*/14.39, /*27*/14.47},
{/*4*//*0*/1.61, /*1*/1.62, /*2*/1.62, /*3*/1.95, /*4*/2.48, /*5*/3.34, /*6*/4.19, /*7*/5.07, /*8*/6.21, /*9*/7.52, /*10*/9.22, /*11*/10.21, /*12*/13.77, /*13*/14.59, /*14*/14.6, /*15*/14.6, /*16*/14.59, /*17*/14.6, /*18*/14.59, /*19*/14.6, /*20*/14.61, /*21*/14.59, /*22*/14.57, /*23*/14.89, /*24*/14.85, /*25*/14.85, /*26*/14.86, /*27*/14.88},
{/*5*//*0*/1.62, /*1*/1.6, /*2*/1.6, /*3*/1.78, /*4*/2.23, /*5*/2.95, /*6*/3.63, /*7*/4.42, /*8*/5.36, /*9*/6.46, /*10*/7.92, /*11*/8.68, /*12*/10.71, /*13*/14.32, /*14*/14.35, /*15*/14.35, /*16*/14.35, /*17*/14.35, /*18*/14.35, /*19*/14.35, /*20*/14.34, /*21*/14.35, /*22*/14.43, /*23*/14.32, /*24*/14.35, /*25*/14.35, /*26*/14.35, /*27*/14.34},
{/*6*//*0*/1.62, /*1*/1.61, /*2*/1.62, /*3*/1.66, /*4*/2.05, /*5*/2.44, /*6*/3.57, /*7*/3.9, /*8*/4.73, /*9*/5.69, /*10*/7.05, /*11*/7.84, /*12*/9.38, /*13*/10.35, /*14*/14.21, /*15*/14.6, /*16*/14.6, /*17*/14.6, /*18*/14.6, /*19*/14.56, /*20*/14.6, /*21*/14.6, /*22*/14.61, /*23*/14.63, /*24*/14.61, /*25*/14.6, /*26*/14.61, /*27*/14.64},
{/*7*//*0*/1.61, /*1*/1.62, /*2*/1.61, /*3*/1.61, /*4*/1.89, /*5*/2.22, /*6*/2.9, /*7*/3.5, /*8*/4.23, /*9*/5.15, /*10*/6.92, /*11*/7.73, /*12*/9.25, /*13*/10.31, /*14*/10.26, /*15*/14.13, /*16*/14.39, /*17*/14.4, /*18*/14.39, /*19*/14.43, /*20*/14.38, /*21*/14.39, /*22*/14.4, /*23*/14.43, /*24*/14.4, /*25*/14.42, /*26*/14.39, /*27*/14.39},
{/*8*//*0*/1.6, /*1*/1.62, /*2*/1.62, /*3*/1.62, /*4*/1.79, /*5*/2.07, /*6*/2.67, /*7*/3.18, /*8*/3.84, /*9*/4.67, /*10*/5.63, /*11*/6.21, /*12*/7.61, /*13*/8.39, /*14*/9.22, /*15*/11.35, /*16*/14.14, /*17*/14.48, /*18*/14.47, /*19*/14.5, /*20*/14.48, /*21*/14.44, /*22*/14.48, /*23*/14.4, /*24*/14.43, /*25*/14.48, /*26*/14.48, /*27*/14.47},
{/*9*//*0*/1.62, /*1*/1.61, /*2*/1.61, /*3*/1.61, /*4*/1.74, /*5*/1.98, /*6*/2.49, /*7*/2.95, /*8*/3.54, /*9*/4.28, /*10*/5.19, /*11*/6.3, /*12*/6.88, /*13*/8.48, /*14*/9.35, /*15*/10.42, /*16*/11.48, /*17*/14.39, /*18*/14.67, /*19*/14.67, /*20*/14.64, /*21*/14.65, /*22*/14.68, /*23*/14.72, /*24*/14.72, /*25*/14.72, /*26*/14.69, /*27*/14.72},
{/*10*//*0*/0.96, /*1*/0.98, /*2*/0.97, /*3*/0.86, /*4*/0.0, /*5*/2.0, /*6*/2.33, /*7*/2.73, /*8*/3.27, /*9*/3.95, /*10*/4.79, /*11*/5.3, /*12*/6.4, /*13*/6.98, /*14*/8.59, /*15*/9.36, /*16*/10.59, /*17*/11.77, /*18*/14.72, /*19*/14.63, /*20*/14.82, /*21*/14.9, /*22*/14.69, /*23*/14.81, /*24*/14.77, /*25*/14.9, /*26*/14.77, /*27*/15.02},
{/*11*//*0*/0.96, /*1*/0.99, /*2*/0.98, /*3*/0.87, /*4*/0.0, /*5*/1.91, /*6*/2.36, /*7*/2.56, /*8*/3.04, /*9*/3.69, /*10*/4.46, /*11*/4.84, /*12*/6.48, /*13*/6.48, /*14*/7.9, /*15*/8.89, /*16*/9.84, /*17*/10.82, /*18*/13.81, /*19*/14.79, /*20*/14.79, /*21*/14.97, /*22*/15.09, /*23*/14.88, /*24*/14.94, /*25*/14.97, /*26*/15.0, /*27*/14.97},
{/*12*//*0*/0.96, /*1*/0.97, /*2*/0.95, /*3*/0.89, /*4*/0.0, /*5*/0.0, /*6*/2.1, /*7*/2.58, /*8*/2.84, /*9*/3.49, /*10*/4.19, /*11*/4.57, /*12*/5.5, /*13*/6.0, /*14*/7.38, /*15*/8.14, /*16*/9.17, /*17*/10.14, /*18*/11.23, /*19*/14.52, /*20*/14.84, /*21*/14.96, /*22*/15.1, /*23*/14.92, /*24*/15.0, /*25*/15.03, /*26*/14.97, /*27*/14.85},
{/*13*//*0*/0.95, /*1*/0.99, /*2*/0.95, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/2.01, /*7*/2.3, /*8*/2.7, /*9*/3.26, /*10*/3.57, /*11*/4.32, /*12*/5.26, /*13*/5.65, /*14*/6.94, /*15*/7.61, /*16*/8.68, /*17*/10.64, /*18*/13.52, /*19*/13.47, /*20*/14.84, /*21*/14.85, /*22*/14.93, /*23*/14.94, /*24*/14.94, /*25*/14.93, /*26*/14.94, /*27*/14.9},
{/*14*//*0*/0.94, /*1*/0.95, /*2*/0.94, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/1.91, /*7*/2.21, /*8*/2.54, /*9*/3.05, /*10*/3.7, /*11*/4.46, /*12*/4.79, /*13*/5.36, /*14*/6.55, /*15*/7.23, /*16*/8.07, /*17*/9.02, /*18*/9.97, /*19*/11.34, /*20*/14.79, /*21*/14.79, /*22*/14.81, /*23*/14.79, /*24*/14.76, /*25*/14.76, /*26*/14.77, /*27*/14.77},
{/*15*//*0*/0.93, /*1*/0.94, /*2*/0.96, /*3*/0.86, /*4*/0.0, /*5*/0.0, /*6*/1.87, /*7*/2.13, /*8*/2.45, /*9*/2.9, /*10*/3.52, /*11*/3.86, /*12*/4.61, /*13*/5.09, /*14*/6.17, /*15*/6.77, /*16*/7.59, /*17*/8.27, /*18*/9.55, /*19*/10.63, /*20*/13.47, /*21*/14.75, /*22*/14.8, /*23*/14.93, /*24*/14.84, /*25*/14.86, /*26*/14.85, /*27*/14.8},
{/*16*//*0*/0.94, /*1*/0.94, /*2*/0.93, /*3*/0.86, /*4*/0.0, /*5*/0.0, /*6*/1.82, /*7*/2.05, /*8*/2.36, /*9*/2.78, /*10*/3.34, /*11*/3.66, /*12*/4.4, /*13*/4.82, /*14*/5.32, /*15*/6.48, /*16*/7.23, /*17*/8.02, /*18*/9.02, /*19*/12.65, /*20*/12.69, /*21*/14.63, /*22*/14.72, /*23*/15.01, /*24*/15.02, /*25*/15.05, /*26*/15.05, /*27*/15.02},
{/*17*//*0*/0.92, /*1*/0.94, /*2*/0.93, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/2.0, /*8*/2.28, /*9*/2.66, /*10*/3.18, /*11*/3.84, /*12*/4.11, /*13*/4.61, /*14*/5.63, /*15*/6.19, /*16*/6.86, /*17*/8.52, /*18*/8.63, /*19*/9.65, /*20*/10.9, /*21*/13.8, /*22*/14.68, /*23*/15.1, /*24*/15.06, /*25*/15.1, /*26*/15.17, /*27*/15.03},
{/*18*//*0*/0.92, /*1*/0.92, /*2*/0.89, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/1.94, /*8*/2.22, /*9*/2.55, /*10*/3.07, /*11*/3.65, /*12*/4.42, /*13*/4.4, /*14*/5.32, /*15*/5.94, /*16*/6.52, /*17*/7.28, /*18*/9.19, /*19*/9.22, /*20*/10.35, /*21*/12.93, /*22*/14.84, /*23*/15.14, /*24*/15.22, /*25*/15.11, /*26*/15.14, /*27*/15.18},
{/*19*//*0*/0.91, /*1*/0.93, /*2*/0.92, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/2.15, /*9*/2.46, /*10*/2.91, /*11*/3.22, /*12*/3.85, /*13*/4.23, /*14*/5.15, /*15*/5.71, /*16*/6.23, /*17*/7.8, /*18*/7.88, /*19*/8.82, /*20*/9.88, /*21*/12.27, /*22*/14.3, /*23*/14.92, /*24*/15.39, /*25*/15.35, /*26*/15.38, /*27*/15.13},
{/*20*//*0*/0.91, /*1*/0.94, /*2*/0.92, /*3*/0.86, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/2.06, /*9*/2.36, /*10*/2.8, /*11*/3.07, /*12*/3.68, /*13*/4.07, /*14*/4.46, /*15*/5.38, /*16*/6.01, /*17*/7.48, /*18*/7.61, /*19*/8.52, /*20*/9.52, /*21*/10.71, /*22*/13.5, /*23*/15.01, /*24*/14.97, /*25*/15.14, /*26*/15.11, /*27*/15.26},
{/*21*//*0*/0.92, /*1*/0.91, /*2*/0.92, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/2.01, /*9*/2.31, /*10*/2.7, /*11*/3.26, /*12*/3.56, /*13*/3.92, /*14*/4.3, /*15*/5.17, /*16*/5.69, /*17*/6.46, /*18*/7.26, /*19*/8.07, /*20*/9.22, /*21*/10.4, /*22*/11.72, /*23*/14.68, /*24*/14.92, /*25*/14.75, /*26*/14.89, /*27*/14.89},
{/*22*//*0*/0.92, /*1*/0.93, /*2*/0.9, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/1.97, /*9*/2.25, /*10*/2.59, /*11*/2.84, /*12*/3.42, /*13*/3.79, /*14*/4.59, /*15*/5.0, /*16*/5.53, /*17*/6.88, /*18*/6.94, /*19*/7.82, /*20*/9.89, /*21*/10.09, /*22*/11.25, /*23*/14.13, /*24*/14.34, /*25*/14.31, /*26*/14.31, /*27*/14.31}
};

float getFuel(int rpm, float maf) {
	int rpm_index = findIndex(fuel_rpm_table, FUEL_RPM_COUNT, rpm);
	int key_index = findIndex(fuel_maf_table, FUEL_MAF_COUNT, maf);

	/**
	 * first we find the intrpolated value for this RPM
	 */
	int rpmMaxIndex = rpm_index == FUEL_RPM_COUNT - 1 ? rpm_index : rpm_index + 1;

	int rpmMin = fuel_rpm_table[rpm_index];
	int rpmMax = fuel_rpm_table[rpmMaxIndex];
	float rpmMinKeyMinValue = fuel_table[rpm_index][key_index];
	float rpmMaxKeyMinValue = fuel_table[rpmMaxIndex][key_index];

//	printf("%d: range %d - %d\r\n", rpm, rpmMin, rpmMax);
//	printf("rpm range %f   %f\r\n", rpmMinKeyMinValue, rpmMaxKeyMinValue);

	float keyMinValue = interpolate(rpmMin, rpmMinKeyMinValue, rpmMax, rpmMaxKeyMinValue, rpm);

	int keyMaxIndex = key_index == FUEL_MAF_COUNT - 1 ? key_index : key_index + 1;
	float keyMin = fuel_maf_table[key_index];
	float keyMax = fuel_maf_table[keyMaxIndex];
	float rpmMinKeyMaxValue = fuel_table[rpm_index][keyMaxIndex];
	float rpmMaxKeyMaxValue = fuel_table[rpmMaxIndex][keyMaxIndex];

//	printf("%f: range %f - %f\r\n", maf, keyMin, keyMax);
//	printf("key range %f   %f\r\n", rpmMinKeyMaxValue, rpmMaxKeyMaxValue);

	float keyMaxValue = interpolate(rpmMin, rpmMinKeyMaxValue, rpmMax, rpmMaxKeyMaxValue, rpm);

	float result = interpolate(keyMin, keyMinValue, keyMax, keyMaxValue, maf);
	return result * 0.8;
}
