/*
 * fuel.c
 *
 *  Created on: May 27, 2013
 *      Author: Andrey Belomutskiy, (c) 2012-2013
 */

#include "rficonsole.h"
#include "fuel_map.h"
#include "engine_controller.h"

#define FUEL_RPM_COUNT 19
static float fuel_rpm_table[] = {600.0, 900.0, 1200.0, 1500.0, 1800.0, 2100.0, 2400.0, 2700.0, 3000.0, 3300.0, 3600.0, 3900.0, 4200.0, 4500.0, 4800.0, 5100.0, 5400.0, 5700.0, 6000.0};

#define FUEL_MAF_COUNT 33
static float fuel_maf_table[] = {1.0, 1.1, 1.2000000000000002, 1.3000000000000003, 1.4000000000000004, 1.5000000000000004, 1.6000000000000005, 1.7000000000000006, 1.8000000000000007, 1.9000000000000008, 2.000000000000001, 2.100000000000001, 2.200000000000001, 2.300000000000001, 2.4000000000000012, 2.5000000000000013, 2.6000000000000014, 2.7000000000000015, 2.8000000000000016, 2.9000000000000017, 3.0000000000000018, 3.100000000000002, 3.200000000000002, 3.300000000000002, 3.400000000000002, 3.500000000000002, 3.6000000000000023, 3.7000000000000024, 3.8000000000000025, 3.9000000000000026, 4.000000000000003, 4.100000000000002, 4.200000000000002};

static float fuel_table[19][33] = {
{/*0*//*0*/2.49, /*1*/2.48, /*2*/2.48, /*3*/2.49, /*4*/2.65, /*5*/2.66, /*6*/2.65, /*7*/2.66, /*8*/3.48, /*9*/4.46, /*10*/5.65, /*11*/7.26, /*12*/9.68, /*13*/11.8, /*14*/14.55, /*15*/19.45, /*16*/19.8, /*17*/19.79, /*18*/19.8, /*19*/19.79, /*20*/19.79, /*21*/19.79, /*22*/19.79, /*23*/19.79, /*24*/21.68, /*25*/21.68, /*26*/21.68, /*27*/21.67, /*28*/21.67, /*29*/21.67, /*30*/21.67, /*31*/21.67, /*32*/21.68},
{/*1*//*0*/2.49, /*1*/2.49, /*2*/2.49, /*3*/2.65, /*4*/2.64, /*5*/2.65, /*6*/2.64, /*7*/2.65, /*8*/2.64, /*9*/3.47, /*10*/4.32, /*11*/5.44, /*12*/6.96, /*13*/8.35, /*14*/10.14, /*15*/12.27, /*16*/16.51, /*17*/19.13, /*18*/19.12, /*19*/19.13, /*20*/19.13, /*21*/19.12, /*22*/19.12, /*23*/19.12, /*24*/19.12, /*25*/19.12, /*26*/19.11, /*27*/19.12, /*28*/19.12, /*29*/19.12, /*30*/19.11, /*31*/19.12, /*32*/19.12},
{/*2*//*0*/2.49, /*1*/2.48, /*2*/2.63, /*3*/2.63, /*4*/2.61, /*5*/2.61, /*6*/2.6, /*7*/2.63, /*8*/2.63, /*9*/2.95, /*10*/3.53, /*11*/4.38, /*12*/5.65, /*13*/6.71, /*14*/7.94, /*15*/9.6, /*16*/11.68, /*17*/12.93, /*18*/16.92, /*19*/17.32, /*20*/17.31, /*21*/17.32, /*22*/17.34, /*23*/17.32, /*24*/17.34, /*25*/17.32, /*26*/17.32, /*27*/17.34, /*28*/17.34, /*29*/17.32, /*30*/17.79, /*31*/17.32, /*32*/17.32},
{/*3*//*0*/2.49, /*1*/2.61, /*2*/2.6, /*3*/2.61, /*4*/2.61, /*5*/2.6, /*6*/2.6, /*7*/2.6, /*8*/2.6, /*9*/2.65, /*10*/3.08, /*11*/3.75, /*12*/4.78, /*13*/5.67, /*14*/6.67, /*15*/7.94, /*16*/9.6, /*17*/11.71, /*18*/12.88, /*19*/14.22, /*20*/18.18, /*21*/18.18, /*22*/18.18, /*23*/18.18, /*24*/18.18, /*25*/18.17, /*26*/18.18, /*27*/18.15, /*28*/18.17, /*29*/18.17, /*30*/18.18, /*31*/18.17, /*32*/18.17},
{/*4*//*0*/2.49, /*1*/2.61, /*2*/2.6, /*3*/2.61, /*4*/2.6, /*5*/2.6, /*6*/2.6, /*7*/2.63, /*8*/2.59, /*9*/2.6, /*10*/2.82, /*11*/3.36, /*12*/4.15, /*13*/4.9, /*14*/5.79, /*15*/6.86, /*16*/8.17, /*17*/10.07, /*18*/10.86, /*19*/13.22, /*20*/14.56, /*21*/17.72, /*22*/17.73, /*23*/17.73, /*24*/17.73, /*25*/17.71, /*26*/17.73, /*27*/17.72, /*28*/17.73, /*29*/17.72, /*30*/17.71, /*31*/17.72, /*32*/17.73},
{/*5*//*0*/2.48, /*1*/2.6, /*2*/2.6, /*3*/2.61, /*4*/2.59, /*5*/2.61, /*6*/2.59, /*7*/2.6, /*8*/2.61, /*9*/2.61, /*10*/2.67, /*11*/3.1, /*12*/3.74, /*13*/4.36, /*14*/5.13, /*15*/6.09, /*16*/7.26, /*17*/8.76, /*18*/9.64, /*19*/11.64, /*20*/12.86, /*21*/14.22, /*22*/17.34, /*23*/17.9, /*24*/17.9, /*25*/17.9, /*26*/17.92, /*27*/17.9, /*28*/17.92, /*29*/17.9, /*30*/17.93, /*31*/17.92, /*32*/17.9},
{/*6*//*0*/2.49, /*1*/2.59, /*2*/2.61, /*3*/2.6, /*4*/2.61, /*5*/2.63, /*6*/2.61, /*7*/2.63, /*8*/2.61, /*9*/2.61, /*10*/2.6, /*11*/2.92, /*12*/3.47, /*13*/3.99, /*14*/4.63, /*15*/5.52, /*16*/6.59, /*17*/7.13, /*18*/8.46, /*19*/9.47, /*20*/11.39, /*21*/12.56, /*22*/13.77, /*23*/17.95, /*24*/17.96, /*25*/17.95, /*26*/17.97, /*27*/17.96, /*28*/17.95, /*29*/17.95, /*30*/17.95, /*31*/17.95, /*32*/17.97},
{/*7*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/2.77, /*12*/3.27, /*13*/3.66, /*14*/4.26, /*15*/5.05, /*16*/6.0, /*17*/6.46, /*18*/7.63, /*19*/9.22, /*20*/10.22, /*21*/11.22, /*22*/12.47, /*23*/17.09, /*24*/18.1, /*25*/19.79, /*26*/18.1, /*27*/18.11, /*28*/18.09, /*29*/18.11, /*30*/18.1, /*31*/18.1, /*32*/18.1},
{/*8*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/2.66, /*6*/2.58, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/2.91, /*13*/3.43, /*14*/3.93, /*15*/4.38, /*16*/5.48, /*17*/6.46, /*18*/7.01, /*19*/7.59, /*20*/9.25, /*21*/10.28, /*22*/11.27, /*23*/14.01, /*24*/13.97, /*25*/17.48, /*26*/18.59, /*27*/18.57, /*28*/18.59, /*29*/18.6, /*30*/18.57, /*31*/28.87, /*32*/18.59},
{/*9*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/2.79, /*13*/3.27, /*14*/3.7, /*15*/4.32, /*16*/5.11, /*17*/5.57, /*18*/6.46, /*19*/7.78, /*20*/8.47, /*21*/9.47, /*22*/10.38, /*23*/11.59, /*24*/14.51, /*25*/18.12, /*26*/18.18, /*27*/18.18, /*28*/18.17, /*29*/18.17, /*30*/18.18, /*31*/18.18, /*32*/18.17},
{/*10*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/2.83, /*13*/3.15, /*14*/3.52, /*15*/4.07, /*16*/4.79, /*17*/5.17, /*18*/6.09, /*19*/6.65, /*20*/7.98, /*21*/8.76, /*22*/9.68, /*23*/11.98, /*24*/13.31, /*25*/16.61, /*26*/18.31, /*27*/18.3, /*28*/18.3, /*29*/18.3, /*30*/18.31, /*31*/18.31, /*32*/18.31},
{/*11*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/0.0, /*13*/3.0, /*14*/3.38, /*15*/3.83, /*16*/4.44, /*17*/5.3, /*18*/5.73, /*19*/6.21, /*20*/7.44, /*21*/8.18, /*22*/9.02, /*23*/10.02, /*24*/12.53, /*25*/14.03, /*26*/17.44, /*27*/17.37, /*28*/18.5, /*29*/18.48, /*30*/18.48, /*31*/18.48, /*32*/18.47},
{/*12*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/0.0, /*13*/2.92, /*14*/3.25, /*15*/3.67, /*16*/4.28, /*17*/4.63, /*18*/5.44, /*19*/5.92, /*20*/7.01, /*21*/7.65, /*22*/8.46, /*23*/9.39, /*24*/10.44, /*25*/11.68, /*26*/13.1, /*27*/18.47, /*28*/18.46, /*29*/18.47, /*30*/18.47, /*31*/18.47, /*32*/18.46},
{/*13*//*0*/0.0, /*1*/0.0, /*2*/2.67, /*3*/0.0, /*4*/0.0, /*5*/2.67, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/0.0, /*13*/0.0, /*14*/3.16, /*15*/3.87, /*16*/4.05, /*17*/4.79, /*18*/5.17, /*19*/6.09, /*20*/6.67, /*21*/7.28, /*22*/7.98, /*23*/8.79, /*24*/9.86, /*25*/12.34, /*26*/13.84, /*27*/13.84, /*28*/17.17, /*29*/18.8, /*30*/18.93, /*31*/27.04, /*32*/18.81},
{/*14*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/0.0, /*13*/0.0, /*14*/3.03, /*15*/3.41, /*16*/3.88, /*17*/4.57, /*18*/4.9, /*19*/5.65, /*20*/6.32, /*21*/6.92, /*22*/7.55, /*23*/8.35, /*24*/10.44, /*25*/11.68, /*26*/11.69, /*27*/13.14, /*28*/14.79, /*29*/18.59, /*30*/18.61, /*31*/18.62, /*32*/18.61},
{/*15*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/0.0, /*13*/0.0, /*14*/2.95, /*15*/3.29, /*16*/3.72, /*17*/4.36, /*18*/4.69, /*19*/5.38, /*20*/6.03, /*21*/6.61, /*22*/7.21, /*23*/8.85, /*24*/9.92, /*25*/11.11, /*26*/11.1, /*27*/12.57, /*28*/14.07, /*29*/15.85, /*30*/18.12, /*31*/18.1, /*32*/18.12},
{/*16*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/0.0, /*13*/0.0, /*14*/0.0, /*15*/3.21, /*16*/3.61, /*17*/3.85, /*18*/4.46, /*19*/5.3, /*20*/5.77, /*21*/6.3, /*22*/6.9, /*23*/8.39, /*24*/8.38, /*25*/10.51, /*26*/10.52, /*27*/11.88, /*28*/13.42, /*29*/15.06, /*30*/17.59, /*31*/17.59, /*32*/17.57},
{/*17*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/2.18, /*13*/2.61, /*14*/2.81, /*15*/3.13, /*16*/3.5, /*17*/3.73, /*18*/4.3, /*19*/4.67, /*20*/5.87, /*21*/6.03, /*22*/6.63, /*23*/8.02, /*24*/8.92, /*25*/9.97, /*26*/10.03, /*27*/11.28, /*28*/12.79, /*29*/14.36, /*30*/16.63, /*31*/16.62, /*32*/16.63},
{/*18*//*0*/0.0, /*1*/0.0, /*2*/0.0, /*3*/0.0, /*4*/0.0, /*5*/0.0, /*6*/0.0, /*7*/0.0, /*8*/0.0, /*9*/0.0, /*10*/0.0, /*11*/0.0, /*12*/0.0, /*13*/0.0, /*14*/0.0, /*15*/3.02, /*16*/3.4, /*17*/3.6, /*18*/4.13, /*19*/4.86, /*20*/5.32, /*21*/5.8, /*22*/6.32, /*23*/6.94, /*24*/8.61, /*25*/9.59, /*26*/10.72, /*27*/10.72, /*28*/12.1, /*29*/13.67, /*30*/15.81, /*31*/15.81, /*32*/15.81}
};


float getFuel(int rpm, float maf) {
	int rpm_index = findIndex(&fuel_rpm_table, FUEL_RPM_COUNT, rpm);
	int maf_index = findIndex(&fuel_maf_table, FUEL_MAF_COUNT, maf);

	return fuel_table[rpm_index][maf_index];
}

static void showFuelMap(int rpm, int maf100) {
	myfloat maf = maf100 / 100.0;
	myfloat value = getFuel(rpm, maf);
	print("fuel map rpm=%d, maf=%d: %d\r\n", rpm, maf100, (int)(100 * value));
}

void initFuelMap() {
	addConsoleAction2I("sfm", showFuelMap);
	showFuelMap(2400, 280);
}

